<html>
  <head>
    <script language="javascript" type="text/javascript" src="../js/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/jquery.flot.min.js"></script>
  </head>
  <body>
    <div id="data_plot" style="width:600px;height:300px"></div>
    <div id="cost_plot" style="width:600px;height:300px"></div>

    <p id="hoverdata">Position:
    <span id="x">0</span>, <span id="y">0</span><br />
    Click: <span id="clickdata"></span></p>

    <textarea cols=80 rows=20 id="points"></textarea>

<script type="text/javascript">
var plot, cost_plot;
var points, cost_line_points;
var points_range = {
    x: { min: 0, max: 10 },
    y: { min: 0, max: 10 }
};
var cost_data;
var cost_param_ranges = {
    x: { min: -10, max: 10, step: 0.5 },
    y: { min: -10, max: 10, step: 0.5 },
};
    

function create_linear_func(params) {
    return function(x) {
        return params[0] * x + params[1];
    };
};


function calculate_cost_data(points, create_func, params) {
    func = create_func(params);
    var sum = points.reduce(function(acc, point) {
        return acc + Math.pow(func(point[0]) - point[1], 2);
    }, 0);
    return 1 / ( 2 * points.length ) * sum;
};


function calculate_cost_data_2d(points, func) {
    var cost_data = [];
    for(param0 = cost_param_ranges.x.min;
        param0 <= cost_param_ranges.x.max;
        param0 += cost_param_ranges.x.step) {
        // We only want a 2d plot for y (param1) is a constant of 0.
        cost = calculate_cost_data(points, func, [param0, 0]);
        cost_data.push([param0, cost]);
    }
    return cost_data;
};


function generate_cost_data() {
    cost_data = calculate_cost_data_2d(
        points,
        create_linear_func
    );
}


function find_best_fit(cost_data) {
    var best_point = [ null, null ];
    for(var cost_point in cost_data) {
        if( best_point[1] == null || cost_point[1] < best_point[1] ) {
            best_point = cost_point;
        }
    }
    return best_point;
}


function generate_cost_line_data() {
    best_point = find_best_fit(cost_data);

    linear_func = create_linear_func(best_point);
    start_point = [points_range.x.min, Number(linear_func(points_range.x.min))];
    end_point   = [points_range.x.max, Number(linear_func(points_range.x.max))];

    return([start_point, end_point]);
}


$(function () {
    points = [ [ 1, 1 ], [ 2, 2 ], [ 3, 3 ] ];
    generate_cost_data();

    plot = $.plot($("#data_plot"),
            [ {
                    data: points,
                    label: "data points",
                    color: "red",
                    points: { show: true }
            },
            {
                    data: generate_cost_line_data(),
                    color: "blue",
                    lines: { show: true }
            } ],
            {
                series: {
                    points: { show: true }
                },
                grid: { hoverable: true, clickable: true },
                xaxis: points_range.x,
                yaxis: points_range.y,
            });

    cost_plot = $.plot($("#cost_plot"),
           [ { data: cost_data,
               label: "cost",
               color: "green" } ], {
               series: {
                   lines: { show: true },
                   points: { show: true }
               },
               grid: { hoverable: false, clickable: false },
               xaxis: cost_param_ranges.x,
             });

    var currentPoint = null;
    $("#data_plot").bind("plothover", function (event, pos, item) {
        currentPoint = [Math.round(pos.x * 100) / 100,
                        Math.round(pos.y * 100) / 100]
        $("#x").text(currentPoint[0])
        $("#y").text(currentPoint[1])
    });

    $("#data_plot").bind("click", function (event) {
        points.push(currentPoint);
        $('#points').val(JSON.stringify(points, null, 2));
        $("#clickdata").text("Added point " + currentPoint + ".");
        plot.setData([{
            data: points,
            color: "red"
        },
        {
            data: generate_cost_line_data(),
            color: "blue",
            lines: { show: true }
        }]);
        plot.draw();

        generate_cost_data();
        cost_plot.setData([{
            data: cost_data,
            color: "green",
        }]);
        
        cost_plot.draw();
    });
});

</script>
  </body>
</html>
