<html>
  <head>
    <script language="javascript" type="text/javascript" src="../js/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/jquery.flot.min.js"></script>
  </head>
  <body>
    <div id="data_plot" style="width:600px;height:300px"></div>
    <div id="cost_plot" style="width:600px;height:300px"></div>

    <p id="hoverdata">Position:
    <span id="x">0</span>, <span id="y">0</span><br />
    Click: <span id="clickdata"></span></p>

    <textarea cols=80 rows=20 id="points"></textarea>

<script type="text/javascript">
var plot, cost_plot;
var points, cost_line_points;
var points_range = {
    x: { min: 0, max: 10 },
    y: { min: 0, max: 10 }
};
var cost_data;
var cost_param_ranges = {
    x: { min: -0.5, max: 4.5, step: 0.1 },
    y: { min: -0.5, max: 4.5, step: 0.1 },
};
    

function create_linear_func(params) {
    return function(x) {
        return params[0] + params[1] * x;
    };
};


function calculate_cost_data_2d(points, func) {
    var cost_data = [];
    for(param1 = cost_param_ranges.x.min;
        param1 <= cost_param_ranges.x.max;
        param1 += cost_param_ranges.x.step) {
        // We only want a 2d plot so y (param0) is a constant of 0.
        cost = calculate_cost_for_params(points, func, [0, param1]);
        cost_data.push([param1, cost]);
    }
    return cost_data;
};


function calculate_cost_for_params(points, create_func, params) {
    hypothesis = create_func(params);
    var sum = points.reduce(function(acc, point) {
        return acc + Math.pow(hypothesis(point[0]) - point[1], 2);
    }, 0);
    return ( 1 / ( 2 * points.length ) ) * sum;
};


function generate_cost_data() {
    cost_data = calculate_cost_data_2d(
        points,
        create_linear_func
    );
}


function find_best_fitting_params(cost_data) {
    var best_cost = [ null, null ];
    for(var i=0; i < cost_data.length; i++) {
        if( best_cost[1] == null || cost_data[i][1] < best_cost[1] ) {
            best_cost = cost_data[i];
        }
    }
    return [0,best_cost[0]];
}


function generate_cost_line_points() {
    best_params = find_best_fitting_params(cost_data);

    linear_func = create_linear_func(best_params);
    start_point = [points_range.x.min, Number(linear_func(points_range.x.min))];
    end_point   = [points_range.x.max, Number(linear_func(points_range.x.max))];

    return([start_point, end_point]);
}


function plot_points() {
    plot.setData([{
        data: points,
        color: "red"
    },
    {
        data: generate_cost_line_points(),
        color: "blue",
        lines: { show: true }
    }]);
    plot.draw();
}


function plot_cost_data() {
    cost_plot.setData([{
        data: cost_data,
        color: "green",
    }]);
    cost_plot.draw();
}


$(function () {
    points = [ [ 1, 1 ], [ 2, 2 ], [ 3, 3 ] ];
    generate_cost_data();

    plot = $.plot($("#data_plot"),
            [ {
                    data: points,
                    label: "data points",
                    color: "red",
                    points: { show: true }
            },
            {
                    data: generate_cost_line_points(),
                    color: "blue",
                    lines: { show: true },
                    points: { show: false }
            } ],
            {
                series: {
                    points: { show: true }
                },
                grid: { hoverable: true, clickable: true },
                xaxis: points_range.x,
                yaxis: points_range.y,
            });

    cost_plot = $.plot($("#cost_plot"),
           [ { data: cost_data,
               label: "cost",
               color: "green" } ], {
               series: {
                   lines: { show: true },
                   points: { show: false }
               },
               grid: { hoverable: false, clickable: false },
               xaxis: cost_param_ranges.x,
               yaxis: cost_param_ranges.y,
             });

    var currentPoint = null;
    $("#data_plot").bind("plothover", function (event, pos, item) {
        currentPoint = [Math.round(pos.x * 100) / 100,
                        Math.round(pos.y * 100) / 100]
        $("#x").text(currentPoint[0])
        $("#y").text(currentPoint[1])
    });

    $("#data_plot").bind("click", function (event) {
        if(currentPoint == null)
            return;
        points.push(currentPoint);
        $('#points').val(JSON.stringify(points, null, 2));
        $("#clickdata").text("Added point " + currentPoint + ".");

        plot_cost_data();
        generate_cost_data();
        plot_points();
    });

    $('#points').change(function() {
        points = JSON.parse($('#points').val());
        plot_cost_data();
        generate_cost_data();
        plot_points();
    });
});
// [
//  [3,2],
//  [1,2],
//  [0,1],
//  [4,3]
// ]


</script>
  </body>
</html>
