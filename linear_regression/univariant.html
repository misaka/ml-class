<html>
  <head>
    <script language="javascript" type="text/javascript" src="../js/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/jquery.flot.min.js"></script>
  </head>
  <body>
    <div id="data_plot" style="width:600px;height:300px"></div>
    <div id="cost_plot" style="width:600px;height:300px"></div>

    <p id="hoverdata">Position:
    <span id="x">0</span>, <span id="y">0</span><br />
    Click: <span id="clickdata"></span></p>

    <textarea cols=80 rows=20 id="points"></textarea>

<script type="text/javascript">
var plot, cost_plot;
var points, cost_line_points;
var points_range = {
    x: { min: 0, max: 10 },
    y: { min: 0, max: 10 }
};
var cost_data;
var cost_param_ranges = {
    x: { min: -0.5, max: 4.5, step: 0.1 },
    y: { min: -0.5, max: 4.5, step: 0.1 },
};
    

function create_linear_func(params) {
    return function(point) {
        return params[0] + params[1] * point.x;
    };
};


function find_best_fitting_params_for_points(points) {
    var last_params = [];
    var params = [0, 0];
    var change_rate = 0.1;
    var i = 0;
    var max_iterations = 100;

    while(params[0] != last_params[0] || params[1] != last_params[1]) {
        last_params[0] = params[0];
        last_params[1] = params[1];
        h = hypothesis = create_linear_func(params)
        params[1] =
            last_params[1]
            - (change_rate 
               * (1 / points.length)
               * points.reduce(function(a,p) {
                   // console.log("params = " + JSON.stringify(params) + "; p = " + JSON.stringify(p) + "; h(p) = " + h(p) + "; result = " + ((h(p) - p.y) * p.x));
                   return a + (h(p) - p.y) * p.x;
               }, 0)
              );
        if(++i > max_iterations)
            break;
    }
    return params;
}


function calculate_and_plot_points_and_costs() {
    // First re-plat the points without the hypothesis line.
    plot.setData([{
        data: points.map(function(p){return [p.x, p.y]}),
        color: "red",
        label: "data points",
        points: { show: true },
        lines: { show: false },
    }]);
    plot.draw();

    // TODO: There is still a bug ... plot about 14-15 more points and the line
    //       goes a bit haywire. Actually, can happen after just 9 new points
    //       when whey're clustered close together.
    // Now find the best-fitting params for our set of points.
    best_fit_params = find_best_fitting_params_for_points(points);
    // best_fit_params = [0, 3];
    // And generate the points that will be used for the line that represents
    // our hypothesis on the points graph.
    linear_func = create_linear_func(best_fit_params);
    line_start = [points_range.x.min, Number(linear_func({x: points_range.x.min,
                                                          y: 0}))];
    line_end   = [points_range.x.max, Number(linear_func({x: points_range.x.max,
                                                          y: 0}))];

    // Now plot points with the hypothesis line.
    plot.setData([{
        data: points.map(function(p){return [p.x, p.y]}),
        color: "red",
        label: "data points",
    }, {
        data: [line_start, line_end],
        color: "blue",
        label: "costs",
        lines: { show: true },
        points: { show: false },
    }]);
    plot.draw();

    cost_plot.setData([{
        data: cost_data,
        color: "green",
    }]);
    cost_plot.draw();
}


$(function () {
    points = [
        { x: 1, y: 1 },
        { x: 2, y: 2 },
        { x: 3, y: 3 },
    ];

    plot = $.plot($("#data_plot"),
            [{}],
            {
                series: {
                    lines: { show: false },
                    points: { show: true },
                },
                grid: { hoverable: true, clickable: true },
                xaxis: points_range.x,
                yaxis: points_range.y,
            });
    cost_plot = $.plot($("#cost_plot"),
                       [{}], {
               series: {
                   lines: { show: true },
                   points: { show: false }
               },
               grid: { hoverable: false, clickable: false },
               xaxis: cost_param_ranges.x,
               yaxis: cost_param_ranges.y,
             });
    calculate_and_plot_points_and_costs();

    var currentPoint = null;
    $("#data_plot").bind("plothover", function (event, pos, item) {
        currentPoint = { x: Math.round(pos.x * 100) / 100,
                         y: Math.round(pos.y * 100) / 100};
        $("#x").text(currentPoint.x);
        $("#y").text(currentPoint.y);
    });

    $("#data_plot").bind("click", function (event) {
        if(currentPoint == null)
            return;
        points.push(currentPoint);
        $('#points').val(JSON.stringify(points, null, 2));
        $("#clickdata").text("Added point " + currentPoint + ".");
        calculate_and_plot_points_and_costs();
    });

    $('#points').change(function() {
        points = JSON.parse($('#points').val());
        calculate_and_plot_points_and_costs();
    });
});

</script>
  </body>
</html>
