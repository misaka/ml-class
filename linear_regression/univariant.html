<html>
  <head>
    <script language="javascript" type="text/javascript" src="../js/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/jquery.flot.min.js"></script>
  </head>
  <body>
    <div id="data_plot" style="width:600px;height:300px"></div>
    <div id="cost_plot" style="width:600px;height:300px"></div>

    <p id="hoverdata">Position:
    <span id="x">0</span>, <span id="y">0</span><br />
    Click: <span id="clickdata"></span></p>

    <textarea cols=80 rows=20 id="points"></textarea>

<script type="text/javascript">
var plot, cost_plot;
var points, cost_line_points;
var points_range = {
    x: { min: 0, max: 10 },
    y: { min: 0, max: 10 }
};
var cost_data;
var cost_param_ranges = {
    x: { min: -0.5, max: 4.5, step: 0.1 },
    y: { min: -0.5, max: 4.5, step: 0.1 },
};
    

function create_linear_func(params) {
    return function(x) {
        return params[0] + params[1] * x;
    };
};


function calculate_cost_data_2d(points, func) {
    var cost_data = [];
    for(param1 = cost_param_ranges.x.min;
        param1 <= cost_param_ranges.x.max;
        param1 += cost_param_ranges.x.step) {
        // We only want a 2d plot so y (param0) is a constant of 0.
        cost = cost_of_params([0, param1], points, func);
        cost_data.push([param1, cost]);
    }
    return cost_data;
};


function cost_of_params(params, points, create_func) {
    hypothesis = create_func(params);
    var sum = points.reduce(function(acc, point) {
        return acc + Math.pow(hypothesis(point[0]) - point[1], 2);
    }, 0);
    return ( 1 / ( 2 * points.length ) ) * sum;
};


function find_best_fitting_params(cost_data) {
    var best_cost = [ null, null ];
    for(var i=0; i < cost_data.length; i++) {
        if( best_cost[1] == null || cost_data[i][1] < best_cost[1] ) {
            best_cost = cost_data[i];
        }
    }
    return [0,best_cost[0]];
}


function find_best_fitting_params_for_points(points) {
    cost_data = calculate_cost_data_2d(
        points,
        create_linear_func
    );
    return find_best_fitting_params(cost_data);
}


function calculate_and_plot_points_and_costs() {
    // First re-plat the points without the hypothesis line.
    plot.setData([{
        data: points,
        color: "red",
        label: "data points",
        points: { show: true },
        lines: { show: false },
    }]);
    plot.draw();

    // Now find the best-fitting params for our set of points.
    best_fit_params = find_best_fitting_params_for_points(points);
    // And generate the points that will be used for the line that represents
    // our hypothesis on the points graph.
    linear_func = create_linear_func(best_fit_params);
    line_start = [points_range.x.min, Number(linear_func(points_range.x.min))];
    line_end   = [points_range.x.max, Number(linear_func(points_range.x.max))];

    // Now plot points with the hypothesis line.
    plot.setData([{
        data: points,
        color: "red",
        label: "data points",
    }, {
        data: [line_start, line_end],
        color: "blue",
        label: "costs",
        lines: { show: true },
        points: { show: false },
    }]);
    plot.draw();

    cost_plot.setData([{
        data: cost_data,
        color: "green",
    }]);
    cost_plot.draw();
}


$(function () {
    points = [ [ 1, 1 ], [ 2, 2 ], [ 3, 3 ] ];

    plot = $.plot($("#data_plot"),
            [],
            {
                series: {
                    lines: { show: false },
                    points: { show: true },
                },
                grid: { hoverable: true, clickable: true },
                xaxis: points_range.x,
                yaxis: points_range.y,
            });
    cost_plot = $.plot($("#cost_plot"),
                       [ {
                           // data: cost_data,
                           // label: "cost",
                           // color: "green",
                         } ], {
               series: {
                   lines: { show: true },
                   points: { show: false }
               },
               grid: { hoverable: false, clickable: false },
               xaxis: cost_param_ranges.x,
               yaxis: cost_param_ranges.y,
             });
    calculate_and_plot_points_and_costs();

    var currentPoint = null;
    $("#data_plot").bind("plothover", function (event, pos, item) {
        currentPoint = [Math.round(pos.x * 100) / 100,
                        Math.round(pos.y * 100) / 100]
        $("#x").text(currentPoint[0])
        $("#y").text(currentPoint[1])
    });

    $("#data_plot").bind("click", function (event) {
        if(currentPoint == null)
            return;
        points.push(currentPoint);
        $('#points').val(JSON.stringify(points, null, 2));
        $("#clickdata").text("Added point " + currentPoint + ".");
        calculate_and_plot_points_and_costs();
    });

    $('#points').change(function() {
        points = JSON.parse($('#points').val());
        calculate_and_plot_points_and_costs();
    });
});

</script>
  </body>
</html>
